import{B as D,u as de,r as d,l as O,K as W,o as me,L as ve,c as o,a as t,t as u,k as R,F as K,f as H,q as F,p as _,v as w,x as z,b as pe,w as fe,d as _e,e as ye,m as Q,M as he,N as be,O as we,i as n,n as Y,P as G,Q as ge}from"./index-Cr_hIVC8.js";const ke={class:"panel"},xe={class:"row g-4"},Re={class:"col-12 col-lg-4"},Se={class:"card border-0 mb-4"},Ce={class:"card-body"},Le={key:0,class:"alert alert-info"},Ue={key:1,class:"alert alert-danger"},Ae={key:2,class:"list-group list-group-flush"},Ve={key:0,class:"list-group-item bg-transparent text-white-50"},Ne={class:"mb-0 fw-semibold"},Te={class:"text-white-50"},Ee=["disabled","onClick"],$e={key:0},Oe={key:1},je={key:2},Be={key:3},Me={key:4},qe={class:"card border-0 mb-4"},De={class:"card-body"},Fe={class:"col-12"},Ie={class:"col-12"},Je={class:"col-12 form-check form-switch"},Pe={key:0,class:"col-12"},We={class:"col-12"},Ke=["disabled"],He={key:0},ze={key:1},Qe={class:"card border-0"},Ye={class:"card-body"},Ge={class:"col-12"},Xe={class:"col-12"},Ze={class:"col-12"},et=["disabled"],tt={key:0},st={key:1},at={class:"col-12 col-lg-8"},ot={class:"card border-0 h-100"},nt={class:"card-body d-flex flex-column gap-3 h-100"},lt={class:"d-flex justify-content-between align-items-center"},it={class:"text-light mb-1"},rt={class:"text-white-50 mb-0"},ct={key:0,class:"text-white-50 small mb-0"},ut={class:"d-flex gap-2"},dt=["disabled"],mt={key:0},vt={key:1},pt={key:0,class:"alert alert-info"},ft={key:1,class:"alert alert-secondary"},_t={key:2,class:"chat-messages list-group list-group-flush"},yt={class:"d-flex justify-content-between"},ht={class:"mt-1"},bt={key:3,class:"alert alert-warning"},wt={key:4,class:"alert alert-danger"},gt={key:5,class:"alert alert-warning"},kt={key:0,class:"form-check form-switch mb-3"},xt={class:"form-check-label text-white-50",for:"chatAnon"},Rt={key:1,class:"text-white-50 small"},St=["disabled"],Ct={key:0},Lt={key:1},Ut={key:7,class:"alert alert-info mt-auto"},At={key:8,class:"alert alert-warning mt-auto"},X=80,Et={__name:"ChatView",setup(Vt){const{profile:g,ensureProfileLoaded:Z}=de(),j=D(()=>!!g.value?.user?.is_staff),B=d([]),M=d(!1),S=d(""),l=d(null),C=d(null),L=d(!1),h=d([]),v=O({content:"",is_anonymous:!0}),U=d(!1),A=d(!1),i=d(""),c=O({status:"idle",error:""}),r=O({name:"",capacity:10,is_private:!1,password:""}),V=d(!1),p=O({name:"",password:""}),N=d(!1);let b=null,T=!1;const y=d(null),ee=D(()=>!j.value),te=s=>{if(!s)return"";const e=typeof s=="string"?new Date(s):s;return Number.isNaN(e.getTime())?"":new Intl.DateTimeFormat("ko-KR",{dateStyle:"short",timeStyle:"short"}).format(e)},se=D(()=>!!(g.value&&l.value&&v.content.trim())&&c.status==="open"),k=async()=>{M.value=!0,S.value="";try{const s=await he();B.value=Array.isArray(s?.rooms)?s.rooms:[]}catch(s){console.error(s),S.value="채팅방 목록을 불러오지 못했습니다."}finally{M.value=!1}},E=s=>{l.value=s||null},I=(()=>{if(typeof window>"u")return null;const s=window.API_BASE_URL||void 0||"/api";try{const e=new URL(s,window.location.origin);return`${e.protocol==="https:"?"wss:":"ws:"}//${e.host}`}catch{return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}`}})(),ae=s=>{const e=we();return!e||!I?null:`${I}/ws/chatrooms/${s}/?token=${encodeURIComponent(e)}`},oe=()=>{b&&(clearTimeout(b),b=null)},$=()=>{if(T=!1,oe(),y.value)try{y.value.close()}catch{}y.value=null,l.value?c.status="closed":c.status="idle"},ne=()=>{!T||b||(b=window.setTimeout(()=>{b=null,l.value&&q(l.value.id)},3e3))},q=s=>{if($(),!s)return;const e=ae(s);if(!e){i.value="로그인 후 이용해 주세요.";return}T=!0,c.status="connecting",c.error="",U.value=!0;const m=new WebSocket(e);y.value=m,m.addEventListener("open",()=>{c.status="open",c.error="",m.send(JSON.stringify({action:"fetch_history"}))}),m.addEventListener("message",a=>{try{const f=JSON.parse(a.data);if(f.event==="history")h.value=Array.isArray(f.messages)?f.messages.slice(-X):[],U.value=!1;else if(f.event==="message"){const P=f.message;P&&(h.value=[...h.value,P].slice(-X))}else f.event==="error"&&(i.value=f.detail||"실시간 채팅 오류가 발생했습니다.")}catch(f){console.error("WebSocket message parse error",f)}}),m.addEventListener("close",()=>{y.value=null,T&&l.value?(c.status="closed",ne()):c.status=l.value?"closed":"idle"}),m.addEventListener("error",a=>{console.error("WebSocket error",a),c.error="실시간 연결에 문제가 발생했습니다."})};W(j,s=>{s&&(v.is_anonymous=!1)},{immediate:!0}),W(l,s=>{h.value=[],i.value="",s?q(s.id):($(),U.value=!1)});const x=()=>g.value?!0:(i.value="로그인 후 이용해 주세요.",!1),le=async s=>{if(x()){C.value=s.id,i.value="";try{const e=await G({name:s.name});E(e?.room??null),s.is_private||await k()}catch(e){console.error(e),i.value=e?.payload?.detail||"채팅방에 입장하지 못했습니다."}finally{C.value=null}}},ie=async()=>{if(x()){if(!p.name.trim()){i.value="비공개 채팅방 이름을 입력해주세요.";return}if(!p.password.trim()){i.value="비공개 채팅방 비밀번호를 입력해주세요.";return}N.value=!0,i.value="";try{const s=await G({name:p.name.trim(),password:p.password});E(s?.room??null),p.name="",p.password=""}catch(s){console.error(s),i.value=s?.payload?.detail||"비공개 채팅방에 입장하지 못했습니다."}finally{N.value=!1}}},re=async()=>{if(x()){V.value=!0,i.value="";try{const s=await ge({name:r.name.trim(),capacity:Number(r.capacity),is_private:r.is_private,password:r.is_private?r.password:""});if(!s?.room)throw new Error("채팅방 응답이 없습니다.");E(s.room),s.room.is_private||await k(),r.name="",r.password="",r.capacity=10,r.is_private=!1}catch(s){console.error(s),i.value=s?.payload?.detail||(s?.payload&&typeof s.payload=="object"?Object.values(s.payload).flat().join(" "):"채팅방을 생성하지 못했습니다.")}finally{V.value=!1}}},ce=async()=>{if(!(!l.value||!x())){L.value=!0,i.value="";try{await be(l.value.id),$(),E(null),await k()}catch(s){console.error(s),i.value=s?.payload?.detail||"채팅방에서 나가지 못했습니다."}finally{L.value=!1}}},J=()=>{if(!x())return;if(!l.value){i.value="먼저 채팅방에 입장해 주세요.";return}if(c.status!=="open"||!y.value){i.value="실시간 연결을 준비 중입니다. 잠시 후 다시 시도해 주세요.",l.value&&q(l.value.id);return}const s=v.content.trim();if(!s){i.value="메시지를 입력해 주세요.";return}A.value=!0;const e={action:"send_message",content:s,is_anonymous:ee.value?v.is_anonymous:!1};try{y.value.send(JSON.stringify(e)),v.content="",i.value=""}catch(m){console.error(m),i.value="메시지를 전송하지 못했습니다."}finally{A.value=!1}},ue=s=>{s.key!=="Enter"||s.shiftKey||s.isComposing||(s.preventDefault(),J())};return me(async()=>{await Z(),await k()}),ve(()=>{$()}),(s,e)=>{const m=ye("router-link");return n(),o("section",ke,[t("div",xe,[t("div",Re,[t("div",Se,[t("div",Ce,[e[8]||(e[8]=t("h5",{class:"text-light mb-3"},"공개 채팅방",-1)),e[9]||(e[9]=t("p",{class:"text-white-50 small mb-3"},"목록에는 누구나 입장 가능한 공개형 채팅방만 표시됩니다.",-1)),M.value?(n(),o("div",Le,"채팅방 목록을 불러오는 중...")):S.value?(n(),o("div",Ue,u(S.value),1)):(n(),o("ul",Ae,[B.value.length?R("",!0):(n(),o("li",Ve," 아직 공개 채팅방이 없습니다. ")),(n(!0),o(K,null,H(B.value,a=>(n(),o("li",{key:a.id,class:"list-group-item d-flex justify-content-between align-items-center bg-transparent text-light"},[t("div",null,[t("p",Ne,u(a.name),1),t("small",Te,u(a.member_count)+"/"+u(a.capacity)+" · "+u(a.owner_username||"운영자"),1)]),t("button",{class:Y(["btn btn-sm nav-hover",a.is_member?"btn-secondary":"btn-outline-light"]),disabled:C.value===a.id||a.member_count>=a.capacity||a.is_member&&l.value&&l.value.id===a.id,type:"button",onClick:f=>le(a)},[C.value===a.id?(n(),o("span",$e,"입장 중...")):a.is_member&&l.value&&l.value.id===a.id?(n(),o("span",Oe,"이용 중")):a.is_member?(n(),o("span",je,"입장 완료")):a.member_count>=a.capacity?(n(),o("span",Be,"정원 초과")):(n(),o("span",Me,"입장"))],10,Ee)]))),128))])),t("button",{class:"btn btn-outline-info nav-hover mt-3 w-100",type:"button",onClick:k},"새로 고침")])]),t("div",qe,[t("div",De,[e[15]||(e[15]=t("h5",{class:"text-light mb-3"},"채팅방 생성",-1)),t("form",{class:"row g-3",autocomplete:"off",onSubmit:F(re,["prevent"])},[t("div",Fe,[e[10]||(e[10]=t("label",{class:"form-label text-white-50"},"채팅방 이름",-1)),_(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>r.name=a),class:"form-control",maxlength:"50",required:""},null,512),[[w,r.name]])]),t("div",Ie,[e[11]||(e[11]=t("label",{class:"form-label text-white-50"},"정원 (2~200명)",-1)),_(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>r.capacity=a),class:"form-control",min:"2",max:"200",type:"number",required:""},null,512),[[w,r.capacity,void 0,{number:!0}]])]),t("div",Je,[_(t("input",{id:"createPrivate","onUpdate:modelValue":e[2]||(e[2]=a=>r.is_private=a),class:"form-check-input",type:"checkbox"},null,512),[[z,r.is_private]]),e[12]||(e[12]=t("label",{class:"form-check-label text-white-50",for:"createPrivate"},"비공개 채팅방",-1))]),r.is_private?(n(),o("div",Pe,[e[13]||(e[13]=t("label",{class:"form-label text-white-50"},"비밀번호",-1)),_(t("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>r.password=a),class:"form-control",type:"password",minlength:"4",required:""},null,512),[[w,r.password]]),e[14]||(e[14]=t("small",{class:"text-white-50"},"비공개 채팅방은 목록에 표시되지 않으며 비밀번호로만 입장합니다.",-1))])):R("",!0),t("div",We,[t("button",{class:"btn btn-primary nav-hover w-100",disabled:V.value,type:"submit"},[V.value?(n(),o("span",He,"생성 중...")):(n(),o("span",ze,"채팅방 생성"))],8,Ke)])],32)])]),t("div",Qe,[t("div",Ye,[e[18]||(e[18]=t("h5",{class:"text-light mb-3"},"비공개 채팅방 입장",-1)),t("form",{class:"row g-3",autocomplete:"off",onSubmit:F(ie,["prevent"])},[t("div",Ge,[e[16]||(e[16]=t("label",{class:"form-label text-white-50"},"채팅방 이름",-1)),_(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>p.name=a),class:"form-control",placeholder:"예) 프로젝트 A",required:""},null,512),[[w,p.name]])]),t("div",Xe,[e[17]||(e[17]=t("label",{class:"form-label text-white-50"},"비밀번호",-1)),_(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>p.password=a),class:"form-control",type:"password",required:""},null,512),[[w,p.password]])]),t("div",Ze,[t("button",{class:"btn btn-outline-light nav-hover w-100",disabled:N.value,type:"submit"},[N.value?(n(),o("span",tt,"입장 중...")):(n(),o("span",st,"입장하기"))],8,et)])],32)])])]),t("div",at,[t("div",ot,[t("div",nt,[t("div",lt,[t("div",null,[t("h5",it,u(l.value?l.value.name:"채팅방을 선택해 주세요"),1),t("p",rt,u(l.value?`정원 ${l.value.member_count}/${l.value.capacity} · ${l.value.is_private?"비공개":"공개"}`:"좌측에서 채팅방을 선택하거나 새로 만들 수 있습니다."),1),l.value?(n(),o("p",ct,u(c.status==="open"?"실시간 연결됨":c.status==="connecting"?"실시간 연결 중...":"실시간 연결이 끊어져 재시도 중입니다."),1)):R("",!0)]),t("div",ut,[pe(m,{class:"btn btn-outline-light btn-sm nav-hover",to:"/boards"},{default:fe(()=>[...e[19]||(e[19]=[_e("게시판 보기",-1)])]),_:1}),l.value?(n(),o("button",{key:0,class:"btn btn-outline-danger btn-sm nav-hover",disabled:L.value,type:"button",onClick:ce},[L.value?(n(),o("span",mt,"나가는 중...")):(n(),o("span",vt,"채팅방 나가기"))],8,dt)):R("",!0)])]),U.value?(n(),o("div",pt,"채팅 메시지를 불러오는 중...")):l.value&&!h.value.length?(n(),o("div",ft," 아직 대화가 없습니다. 첫 메시지를 남겨보세요! ")):l.value?(n(),o("div",_t,[(n(!0),o(K,null,H(h.value,a=>(n(),o("article",{key:a.id,class:"chat-message list-group-item"},[t("div",yt,[t("span",{class:Y(["fw-semibold",{"text-warning":a.is_anonymous}])},u(a.display_name),3),t("small",null,u(te(a.created_at)),1)]),t("p",ht,u(a.content),1)]))),128))])):(n(),o("div",bt,"채팅방을 선택하거나 새로 만들어주세요.")),i.value?(n(),o("div",wt,u(i.value),1)):c.error?(n(),o("div",gt,u(c.error),1)):R("",!0),Q(g)&&l.value?(n(),o("form",{key:6,class:"chat-form mt-auto",autocomplete:"off",onSubmit:F(J,["prevent"])},[j.value?(n(),o("p",Rt,"관리자는 실명(아이디)으로만 메시지를 보낼 수 있습니다.")):(n(),o("div",kt,[_(t("input",{id:"chatAnon","onUpdate:modelValue":e[6]||(e[6]=a=>v.is_anonymous=a),class:"form-check-input",type:"checkbox"},null,512),[[z,v.is_anonymous]]),t("label",xt,u(v.is_anonymous?"익명으로 보내기":"아이디 공개"),1)])),_(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=a=>v.content=a),class:"form-control",name:"chat-content",placeholder:"지금 떠오르는 생각을 적어보세요 (최대 500자)",maxlength:"500",onKeydown:ue},null,544),[[w,v.content]]),t("button",{class:"btn btn-primary nav-hover mt-3",disabled:A.value||!se.value,type:"submit"},[A.value?(n(),o("span",Ct,"전송 중...")):(n(),o("span",Lt,"메시지 전송"))],8,St)],32)):Q(g)?(n(),o("div",Ut," 채팅방에 입장해야 메시지를 보낼 수 있습니다. ")):(n(),o("div",At," 로그인한 사용자만 채팅에 참여할 수 있습니다. 계정 페이지에서 로그인해 주세요. "))])])])])])}}};export{Et as default};
